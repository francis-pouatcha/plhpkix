package org.adorys.plh.pkix.server.test.cmp.messaging;

import java.io.IOException;
import java.net.URL;
import java.security.GeneralSecurityException;

import javax.ws.rs.ApplicationPath;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.Response.Status;

import org.adorsys.plh.pkix.core.x500.X500NameHelper;
import org.adorys.plh.pkix.core.cmp.stores.CertificateStore;
import org.adorys.plh.pkix.core.cmp.stores.PendingCertAnn;
import org.adorys.plh.pkix.core.cmp.stores.PendingPollRequest;
import org.adorys.plh.pkix.core.cmp.stores.PendingResponses;
import org.adorys.plh.pkix.core.cmp.stores.PrivateKeyHolder;
import org.adorys.plh.pkix.server.cmp.utils.JaxRsActivator;
import org.adorys.plh.pkix.server.test.cmp.AbstractCMPMessagingServerTest;
import org.apache.http.HttpResponse;
import org.apache.http.HttpStatus;
import org.bouncycastle.asn1.x500.X500Name;
import org.bouncycastle.cert.CertException;
import org.bouncycastle.cert.cmp.CMPException;
import org.bouncycastle.operator.OperatorCreationException;
import org.jboss.arquillian.container.test.api.Deployment;
import org.jboss.arquillian.container.test.api.RunAsClient;
import org.jboss.arquillian.junit.Arquillian;
import org.jboss.arquillian.test.api.ArquillianResource;
import org.jboss.shrinkwrap.api.spec.WebArchive;
import org.junit.Assert;
import org.junit.Test;
import org.junit.runner.RunWith;

@RunWith(Arquillian.class)
@RunAsClient
public class ScenarioTest {

    private static final String RESOURCE_PREFIX = JaxRsActivator.class.getAnnotation(ApplicationPath.class).value().substring(1);
	
    private static final String SERVICE_NAME = "/messaging";

    @Deployment(testable=false)
    public static WebArchive createDeployment() {
    	return AbstractCMPMessagingServerTest.createDeployment();
    }

    @ArquillianResource
    URL deploymentUrl;
    
	@Test
	public void test() throws OperatorCreationException, GeneralSecurityException, IOException, CertException, CMPException{
		String addressPrefix = deploymentUrl.toString()+ RESOURCE_PREFIX + SERVICE_NAME;

		X500Name adminX500Name = X500NameHelper.makeX500Name("Admin", "admin@plhpkix.biz");
		CMPMessagingClient adminClient = new CMPMessagingClient(adminX500Name, addressPrefix, new PrivateKeyHolder(), 
				new CertificateStore(), new PendingPollRequest(), new PendingCertAnn(), new PendingResponses());

		
		CertificateStore francisCertificateStore = new CertificateStore();
		PendingCertAnn francisPendingCertAnn = new PendingCertAnn();
		X500Name francisX500Name = X500NameHelper.makeX500Name("Francis Pouatcha", "fpo@plhpkix.biz");
		CMPMessagingClient francisClient = new CMPMessagingClient(adminX500Name, addressPrefix, new PrivateKeyHolder(), 
				francisCertificateStore, new PendingPollRequest(), francisPendingCertAnn, new PendingResponses());
		
		adminClient.initKeyPair();
		
		// 1
		Response initialize = adminClient.initialize(adminX500Name);
		Assert.assertTrue(initialize.getStatus()==Status.OK.getStatusCode());

		francisClient.initKeyPair();
		
		// 2
		Response initialize1 = francisClient.initialize(francisX500Name);
		Assert.assertTrue(initialize1.getStatus()==Status.OK.getStatusCode());
		
		// 3
		HttpResponse requestCertificateResp = francisClient.requestCertificate(adminX500Name);
		Assert.assertTrue(requestCertificateResp.getStatusLine().getStatusCode()==HttpStatus.SC_OK);
		
		Response fetchRequestResponse = adminClient.fetchRequests(10, adminX500Name);
		Assert.assertTrue(fetchRequestResponse.getStatus()+"", fetchRequestResponse.getStatus()==Status.OK.getStatusCode());
		
		Response sendResponsesResp = adminClient.sendResponses(adminX500Name);
		Assert.assertTrue(sendResponsesResp.getStatus()==Status.OK.getStatusCode());
		
		Response pollRequestsResp = francisClient.pollRequests(francisX500Name);
		Assert.assertTrue(pollRequestsResp.getStatus()+"",pollRequestsResp.getStatus()==Status.OK.getStatusCode());
		Assert.assertNotNull(francisCertificateStore);
		
		Assert.assertNotNull(francisCertificateStore.getCertificate(francisX500Name, francisX500Name));
		Assert.assertNotNull(francisCertificateStore.getCertificate(francisX500Name, adminX500Name));

		Assert.assertNotNull(francisPendingCertAnn);

		Response announceCertificates = francisClient.announceCertificates();
		Assert.assertTrue(announceCertificates.getStatus()==Status.OK.getStatusCode());
	}
}
